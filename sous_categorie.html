<!DOCTYPE html><!--  This site was created in Webflow. http://www.webflow.com  -->
<!--  Last Published: Tue Jun 08 2021 14:28:35 GMT+0000 (Coordinated Universal Time)  -->
<html data-wf-page="601411f982165761b248f828" data-wf-site="601411f9821657146748f826">
<head>
  <meta charset="utf-8">
  <title>MENU</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="css/style.css">
  
</head>

<div id="loader" class="center"></div>

<body class="body">

  <div class='header'>
        <div id='BTN_BACK' class='back'></div>
        <div id='TITRE' class='titre_header'></div>
  </div>
  
  <div id="BLK_SS_CATEGORIE"></div>

  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=601411f9821657146748f826" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="js/webflow.js" type="text/javascript"></script>
  <!-- [if lte IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/placeholders/3.0.2/placeholders.min.js"></script><![endif] -->
 
  <script type="text/javascript" language="javascript">  
    $(document).ready(function() {  
 
      document.onreadystatechange = function() {
            if (document.readyState !== "complete") {
                document.querySelector(
                  "body").style.visibility = "hidden";
                document.querySelector(
                  "#loader").style.visibility = "visible";
            } else {
                document.querySelector(
                  "#loader").style.display = "none";
                document.querySelector(
                  "body").style.visibility = "visible";
            }
        };
        
        //* ----------------------------------------------------------------------------------------------------
        //* Test si IndexDB est supporté par le navigateur
        //* ----------------------------------------------------------------------------------------------------

        if (!window.indexedDB) {
            console.log(`IndexedDB non supporté par le navigateur`);
            window.location.href = 'anomalie_indexeddb.html';
        } else {
            console.log(`IndexedDB supporté par le navigateur`);                 
        }

        //* ----------------------------------------------------------------------------------------------------
        //* Ouverture de la base de données SO POSING
        //*
        //* La méthode open() renvoie un objet de requête qui est une instance de l' IDBOpenDBRequest interface.
        //* ----------------------------------------------------------------------------------------------------

        const request = indexedDB.open('SOPOSING', 1);

        //* Détection d'une erreur sur l'ouverture de la base de données
        request.onerror = (event) => {
            console.error(`Erreur sur l'ouverture : ${event.target.errorCode}`);
        };

        //* La base de données est ouverte
        request.onsuccess = (event) => {

          let db = event.target.result;

          nro_categorie = parseInt(sessionStorage.getItem("id_categorie"));


          getCategorieById(db, nro_categorie)
          .then(function(result){     
            $('#TITRE').html(result.nom_categorie.toUpperCase()); 

            getSousCategorieByIdCategorie(db, result.id_categorie)
            .then(function(result){ 
                let $ligne = ''; 

                result.forEach(element => {
                  $ligne += `<div id="${element.id_sous_categorie}" class='sous_categorie' style="background: url(data:image/png;base64,${element.photo_sous_categorie}) no-repeat center;"> 
                                  <div id="${element.id_sous_categorie}" class='overlay_light'></div>    
                                  <div id="${element.id_sous_categorie}" class='titre'> ${element.nom_sous_categorie}</div> 
                              </div>`;
                });
                document.getElementById("BLK_SS_CATEGORIE").innerHTML = $ligne;
            })
            .catch(function(result){  
                    let $ligne = '';
                    console.log('KO* ' + result);
            })
          })
          .catch(function(result){   
            console.log('KO');
          });
        };
  
    //* ----------------------------------------------------------------------------------------------------
    //* Accès aux informations "categorie" par le numéroi d'index
    //*
    //* Paramètres : nom de la base de données et id de la catégorie
    //* ----------------------------------------------------------------------------------------------------

    async function getCategorieById(db, id){
        return new Promise(function(resolve, reject){
          
            const txn   = db.transaction('categorie', 'readonly');
            const store = txn.objectStore('categorie');
        
            let query   = store.get(id);
        
            query.onsuccess = (event) => {
                if (!event.target.result) {
                    console.log(`Categorie ${id} not found`);
                } else {
                    resolve(event.target.result);
                 }
            };
        
            query.onerror = (event) => {
                reject(event.target.errorCode);
            }
        });
    }

    //* ----------------------------------------------------------------------------------------------------
    //* Accès aux informations "categorie" par le numéroi d'index
    //*
    //* Paramètres : nom de la base de données et id de la catégorie
    //* ----------------------------------------------------------------------------------------------------

    async function getSousCategorieByIdCategorie(db, id_categorie){
        return new Promise(function(resolve, reject){
            liste = [];

            const txn = db.transaction('sous_categorie', 'readonly');
            const store = txn.objectStore('sous_categorie');

            // return the result object on success
            var request = store.openCursor();
            request.onsuccess = function(event) {
              var cursor = event.target.result;
              if(cursor) {

                if (cursor.value.id_categorie === id_categorie) {

                  let sous_categorie = {
                      id_sous_categorie : cursor.value.id_sous_categorie,
                      nom_sous_categorie : cursor.value.nom_sous_categorie,
                      photo_sous_categorie : cursor.value.photo_sous_categorie,
                      id_categorie : cursor.value.id_categorie,
                      actif : cursor.value.actif_sous_categorie,
                  }
                  liste.push(sous_categorie)
                }
                cursor.continue();
              } else {
                console.table(liste);
                resolve(liste);
              }
            };

        });
    }

        //* ----------------------------------------------------------------------------------------------------
        //* Détection du click sur la catégorie
        //* ----------------------------------------------------------------------------------------------------

        document.getElementById('BLK_SS_CATEGORIE').onclick = function(event) {          
          sessionStorage.setItem("id_sous_categorie",event.target.id);
          window.location = 'pose.html';
        }

        //* ----------------------------------------------------------------------------------------------------
        //* Détection du click sur le bouton BACK
        //* ----------------------------------------------------------------------------------------------------

        document.getElementById('BTN_BACK').onclick = function(event) {
          window.location = 'categorie.html';
        }

    });
</script> 

</body>
</html>