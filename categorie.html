<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>MENU</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">


  <link rel="stylesheet" href="css/style.css">
</head>

<div id="loader" class="center"></div>

<body class="body">

  <div class='header'>
        <div id='BTN_BACK' class='back'></div>
        <div class='titre_header'>CATÉGORIE</div>
  </div>

  <div id="BLK_MENU"></div>

  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=601411f9821657146748f826" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="js/webflow.js" type="text/javascript"></script>
  <!-- [if lte IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/placeholders/3.0.2/placeholders.min.js"></script><![endif] -->
 
  <script type="text/javascript" language="javascript">  
    $(document).ready(function() {  
 
      document.onreadystatechange = function() {
            if (document.readyState !== "complete") {
                document.querySelector(
                  "body").style.visibility = "hidden";
                document.querySelector(
                  "#loader").style.visibility = "visible";
            } else {
                document.querySelector(
                  "#loader").style.display = "none";
                document.querySelector(
                  "body").style.visibility = "visible";
            }
        };

        //* ----------------------------------------------------------------------------------------------------
        //* Test si IndexDB est supporté par le navigateur
        //* ----------------------------------------------------------------------------------------------------

        if (!window.indexedDB) {
            console.log(`IndexedDB non supporté par le navigateur`);
            window.location.href = 'anomalie_indexeddb.html';
        } else {
            console.log(`IndexedDB supporté par le navigateur`);                 
        }

        //* ----------------------------------------------------------------------------------------------------
        //* Ouverture de la base de données SO POSING
        //*
        //* La méthode open() renvoie un objet de requête qui est une instance de l' IDBOpenDBRequest interface.
        //* ----------------------------------------------------------------------------------------------------

        const request = indexedDB.open('SOPOSING', 1);

        //* Détection d'une erreur sur l'ouverture de la base de données
        request.onerror = (event) => {
            console.error(`Erreur sur l'ouverture : ${event.target.errorCode}`);
        };

        //* La base de données est ouverte
        request.onsuccess = (event) => {

          let $ligne = '';
          let db = event.target.result;
          sessionStorage.setItem("db",db);

          getAllCategorie(db)
          .then(function(result){               
             result.forEach(categorie => {
                          
              if (categorie.actif === '1') {
                $ligne += ` <div id="${categorie.id_categorie}" class='categorie' style="background: url(data:image/png;base64,${categorie.photo_categorie}) no-repeat center;"> 
                              <div id="${categorie.id_categorie}" class='overlay_light'></div>    
                              <div id="${categorie.id_categorie}" class='titre'> ${categorie.nom_categorie}</div> 
                            </div>`;
              } else {
                $ligne += `<div class='categorie overlay' style="background: url(data:image/png;base64,${categorie.photo_categorie}) no-repeat center;"> 
                               
                              <div class='titre'> ${categorie.nom_categorie}</div> 
                          </div>`;
              }

             })
             document.getElementById("BLK_MENU").innerHTML = $ligne;
          })
          .catch(function(result){   
            console.log('KO');
          });
        };
  
        //* ----------------------------------------------------------------------------------------------------
        //* Liste des catégories
        //*
        //* Paramètres : nom de la base de données  
        //* ----------------------------------------------------------------------------------------------------

        async function getAllCategorie(db) {
            return new Promise(function(resolve, reject){
              const txn = db.transaction('categorie', "readonly");
              const objectStore = txn.objectStore('categorie');
              liste = [];

              objectStore.openCursor().onsuccess = (event) => {
                let cursor = event.target.result;
                if (cursor) {
                    let contact = cursor.value;
                    //console.log(contact);
                    liste.push(contact);
                    // continue next record
                    cursor.continue();
                } else {
                    resolve(liste);
                }
              };
            });
        };

        //* ----------------------------------------------------------------------------------------------------
        //* Détection du click sur la catégorie
        //* ----------------------------------------------------------------------------------------------------

        document.getElementById('BLK_MENU').onclick = function(event) {          
          if (parseInt(event.target.id) > 0){
            sessionStorage.setItem("id_categorie",event.target.id);
            window.location = 'sous_categorie.html';
          } 
        }
        
        //* ----------------------------------------------------------------------------------------------------
        //* Détection du click sur le bouton BACK
        //* ----------------------------------------------------------------------------------------------------

        document.getElementById('BTN_BACK').onclick = function(event) {
          window.location = 'index.html';
        }

    });
 

</script> 
</body>
</html>
</html>